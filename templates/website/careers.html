{% extends 'website/base.html' %}
{% load static %}

{% block title %}Careers - Join Our Team | Equacare LLC{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header">
    <div class="container">
        <h1>Join Our Team</h1>
        <p>Make a difference in people's lives while building a rewarding career</p>
    </div>
</section>

<!-- Job Listings Section -->
<section class="job-listings">
    <div class="container">
        <div class="section-header">
            <h2>Current Openings</h2>
            <p>Explore opportunities to join our compassionate care team</p>
        </div>
        
        {% if jobs %}
            <div class="jobs-list">
                {% for job in jobs %}
                <div class="job-card">
                    <div class="job-header">
                        <div class="job-title-section">
                            <h3>{{ job.title }}</h3>
                            <div class="job-meta">
                                <span class="job-location"><i class="fas fa-map-marker-alt"></i> {{ job.location }}</span>
                                <span class="job-type"><i class="fas fa-briefcase"></i> {{ job.get_job_type_display }}</span>
                                {% if job.salary_range %}
                                <span class="job-salary"><i class="fas fa-dollar-sign"></i> {{ job.salary_range }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <button class="btn btn-primary apply-btn" data-job-id="{{ job.id }}" data-job-title="{{ job.title }}">
                            Apply Now
                        </button>
                    </div>
                    
                    <div class="job-description">
                        <p>{{ job.description }}</p>
                    </div>
                    
                    <div class="job-details">
                        <div class="job-detail-section">
                            <h4><i class="fas fa-tasks"></i> Responsibilities</h4>
                            <ul>
                                {% for responsibility in job.get_responsibilities_list %}
                                <li>{{ responsibility }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="job-detail-section">
                            <h4><i class="fas fa-check-circle"></i> Qualifications</h4>
                            <ul>
                                {% for qualification in job.get_qualifications_list %}
                                <li>{{ qualification }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        {% if job.get_benefits_list %}
                        <div class="job-detail-section">
                            <h4><i class="fas fa-gift"></i> Benefits</h4>
                            <ul>
                                {% for benefit in job.get_benefits_list %}
                                <li>{{ benefit }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-jobs">
                <i class="fas fa-briefcase"></i>
                <h3>No Openings at This Time</h3>
                <p>We don't have any open positions right now, but we're always interested in meeting talented caregivers. Please check back soon or send us your resume for future opportunities.</p>
                <a href="{% url 'website:contact' %}" class="btn btn-primary">Contact Us</a>
            </div>
        {% endif %}
    </div>
</section>

<!-- Application Modal -->
<div id="applicationModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Apply for <span id="modalJobTitle"></span></h2>
        
        <form id="applicationForm" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="job_id" name="job_id">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="first_name">First Name <span class="required">*</span></label>
                    <input type="text" id="first_name" name="first_name" required>
                </div>
                
                <div class="form-group">
                    <label for="last_name">Last Name <span class="required">*</span></label>
                    <input type="text" id="last_name" name="last_name" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email <span class="required">*</span></label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone <span class="required">*</span></label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="2"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="experience_years">Years of Experience</label>
                    <input type="number" id="experience_years" name="experience_years" min="0" value="0">
                </div>
                
                <div class="form-group">
                    <label for="availability">Availability</label>
                    <input type="text" id="availability" name="availability" placeholder="e.g., Full-time, Weekends">
                </div>
            </div>
            
            <div class="form-group">
                <label for="resume">Resume/CV <span class="required">*</span></label>
                <div class="file-upload-wrapper">
                    <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx" required hidden>
                    <div class="file-drop-area" id="resumeDropArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag & drop your resume here or <span class="file-browse">browse</span></p>
                        <p class="file-hint">Accepts PDF, DOC, DOCX (Max 5MB)</p>
                    </div>
                    <div class="file-preview" id="resumePreview" style="display: none;">
                        <div class="file-info">
                            <i class="fas fa-file-alt"></i>
                            <div class="file-details">
                                <span class="file-name" id="resumeFileName"></span>
                                <span class="file-size" id="resumeFileSize"></span>
                            </div>
                            <button type="button" class="file-remove" id="resumeRemove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="cover_letter">Cover Letter <span class="required">*</span></label>
                <textarea id="cover_letter" name="cover_letter" rows="6" required placeholder="Tell us why you'd be a great fit for this position and what makes you passionate about caregiving..."></textarea>
                <small class="form-hint">Minimum 100 characters</small>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block">
                <span class="btn-text">Submit Application</span>
                <span class="btn-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Submitting...
                </span>
            </button>
            
            <div id="applicationMessage" class="form-message"></div>
        </form>
    </div>
</div>

<!-- CTA Section -->
<section class="careers-cta">
    <div class="container">
        <h2>Questions About Joining Our Team?</h2>
        <p>We'd love to hear from you! Contact us to learn more about career opportunities.</p>
        <div class="cta-buttons">
            {% if site_settings %}
            <a href="tel:{{ site_settings.phone_link }}" class="btn btn-primary btn-lg"><i class="fas fa-phone"></i> Call {{ site_settings.phone }}</a>
            {% else %}
            <a href="tel:+15155081556" class="btn btn-primary btn-lg"><i class="fas fa-phone"></i> Call (515) 508-1556</a>
            {% endif %}
            <a href="{% url 'website:contact' %}" class="btn btn-secondary btn-lg">Contact Us</a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('applicationModal');
    const applyBtns = document.querySelectorAll('.apply-btn');
    const closeBtn = document.querySelector('.close-modal');
    const applicationForm = document.getElementById('applicationForm');
    
    // File upload elements
    const resumeInput = document.getElementById('resume');
    const resumeDropArea = document.getElementById('resumeDropArea');
    const resumePreview = document.getElementById('resumePreview');
    const resumeFileName = document.getElementById('resumeFileName');
    const resumeFileSize = document.getElementById('resumeFileSize');
    const resumeRemove = document.getElementById('resumeRemove');
    
    // Open modal when apply button is clicked
    applyBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const jobId = this.dataset.jobId;
            const jobTitle = this.dataset.jobTitle;
            
            document.getElementById('job_id').value = jobId;
            document.getElementById('modalJobTitle').textContent = jobTitle;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });
    });
    
    // Close modal
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        resetForm();
    });
    
    window.addEventListener('click', function(e) {
        if (e.target == modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            resetForm();
        }
    });
    
    // File upload: Click to browse
    resumeDropArea.addEventListener('click', function() {
        resumeInput.click();
    });
    
    // File upload: Drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        resumeDropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        resumeDropArea.addEventListener(eventName, function() {
            resumeDropArea.classList.add('drag-over');
        }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        resumeDropArea.addEventListener(eventName, function() {
            resumeDropArea.classList.remove('drag-over');
        }, false);
    });
    
    resumeDropArea.addEventListener('drop', function(e) {
        const files = e.dataTransfer.files;
        if (files.length) {
            resumeInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    // File input change
    resumeInput.addEventListener('change', function(e) {
        if (e.target.files.length) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    // Handle file selection
    function handleFileSelect(file) {
        // Validate file type
        const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        if (!allowedTypes.includes(file.type)) {
            alert('Please upload a PDF or Word document.');
            return;
        }
        
        // Validate file size (5MB max)
        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
        if (file.size > maxSize) {
            alert('File size must be less than 5MB.');
            return;
        }
        
        // Show file preview
        resumeFileName.textContent = file.name;
        resumeFileSize.textContent = formatFileSize(file.size);
        resumeDropArea.style.display = 'none';
        resumePreview.style.display = 'block';
    }
    
    // Remove file
    resumeRemove.addEventListener('click', function(e) {
        e.stopPropagation();
        resumeInput.value = '';
        resumeDropArea.style.display = 'block';
        resumePreview.style.display = 'none';
    });
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        else return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
    
    // Reset form
    function resetForm() {
        applicationForm.reset();
        resumeInput.value = '';
        resumeDropArea.style.display = 'block';
        resumePreview.style.display = 'none';
        document.getElementById('applicationMessage').textContent = '';
        document.getElementById('applicationMessage').className = 'form-message';
    }
    
    // Handle form submission
    applicationForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = applicationForm.querySelector('button[type="submit"]');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');
        const formMessage = document.getElementById('applicationMessage');
        
        // Validate cover letter length
        const coverLetter = document.getElementById('cover_letter').value;
        if (coverLetter.length < 100) {
            formMessage.textContent = 'Cover letter must be at least 100 characters.';
            formMessage.className = 'form-message error';
            return;
        }
        
        // Validate resume upload
        if (!resumeInput.files.length) {
            formMessage.textContent = 'Please upload your resume.';
            formMessage.className = 'form-message error';
            return;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline-block';
        formMessage.textContent = '';
        formMessage.className = 'form-message';
        
        // Get form data
        const formData = new FormData(applicationForm);
        
        try {
            const response = await fetch('{% url "website:submit_application" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                formMessage.textContent = result.message;
                formMessage.className = 'form-message success';
                
                // Close modal after 2 seconds
                setTimeout(() => {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    resetForm();
                }, 2500);
            } else {
                formMessage.textContent = result.message;
                formMessage.className = 'form-message error';
            }
        } catch (error) {
            formMessage.textContent = 'An error occurred. Please try again later.';
            formMessage.className = 'form-message error';
        } finally {
            // Reset button state
            submitBtn.disabled = false;
            btnText.style.display = 'inline-block';
            btnLoading.style.display = 'none';
        }
    });
});
</script>
{% endblock %}

